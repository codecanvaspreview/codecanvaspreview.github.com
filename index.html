<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>GitHub .codecanvas Preview</title>
	<style>
		body {
			font: 12px 'Helvetica Neue', Helvetica, Arial, freesans, clean, sans-serif;
			color: #333;
			margin: 0;
			padding: 0;
			height: 100vh;
			overflow: hidden;
		}

		h1 {
			font-size: 20px;
		}

		a {
			color: #666;
		}

		#previewform {
			display: none;
			padding: 20px;
			text-align: center;
			height: 100vh;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}

		strong {
			color: #333;
			background-color: #FAFFA6;
			padding: 0.1em;
		}

		#footer {
			margin: 20px 0;
			font-size: 10px;
			color: #666;
		}

		#preview-container {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			border: none;
			width: 100%;
			height: 100%;
			display: none;
		}

		.error-message {
			color: #ff3b30;
			padding: 20px;
			text-align: center;
			max-width: 600px;
			margin: 100px auto;
			background: #fff3f3;
			border: 1px solid #ffcccb;
			border-radius: 8px;
		}

		.cache-bust-note {
			font-size: 11px;
			color: #666;
			margin-top: 10px;
			font-style: italic;
		}
	</style>
</head>

<body>
	<form id="previewform"
		onsubmit="location.href=window.location.pathname+'?'+encodeURIComponent(this.file.value);return false">
		<h1>GitHub .codecanvas Preview</h1>
		<p>
			Enter URL of the .codecanvas file to preview:
			<input type="url" id="file" value=""
				placeholder="e.g. https://cdn.sdappnet.cloud/rtx/code/openjkdf2.codecanvas" size="60" autofocus>
			<input type="submit" value="Preview">
		</p>
		<p>or prepend to the URL:
			<code><strong>https://codecanvaspreview.github.io/?</strong>https://cdn.sdappnet.cloud/rtx/code/openjkdf2.codecanvas</code>
		</p>
		<p class="cache-bust-note">âœ¨ Tip: Add <code>&amp;t=</code> with a timestamp to force refresh:
			<code>&amp;t=1700000000000</code>
		</p>
		<p id="footer">Developed in 2026 | Contribute on <a
				href="https://github.com/codecanvaspreview/codecanvaspreview.github.com">GitHub</a></p>
	</form>

	<!-- Iframe for previewing .codecanvas files -->
	<iframe id="preview-container" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>

	<script>
		(function () {

			var previewForm = document.getElementById('previewform');
			var previewContainer = document.getElementById('preview-container');

			// Get the base path for this app
			var basePath = window.location.pathname;

			// Get URL from query string
			var url = location.search.substring(1);

			// Check for cache-busting timestamp parameter
			var timestampParam = '';
			var hasTimestamp = false;

			// Extract timestamp if it exists in the format ?url&t=timestamp
			if (url.includes('&t=')) {
				// Extract the actual URL part (before &t=)
				var urlParts = url.split('&t=');
				url = urlParts[0];
				timestampParam = '&t=' + urlParts[1];
				hasTimestamp = true;
			} else if (url.includes('?t=')) {
				// Handle ?url?t=timestamp format (for direct .codecanvas URLs with timestamp)
				var urlParts = url.split('?t=');
				url = urlParts[0];
				timestampParam = '?t=' + urlParts[1];
				hasTimestamp = true;
			}

			// Handle encoded URLs (if they contain :// they should be encoded)
			if (url && !url.includes('://')) {
				// Try to decode the URL if it's encoded
				try {
					var decodedUrl = decodeURIComponent(url);
					if (decodedUrl.startsWith('http://') || decodedUrl.startsWith('https://')) {
						url = decodedUrl;
					}
				} catch (e) {
					// If decoding fails, keep the original
				}
			}

			// Process the URL - handle both raw URLs and GitHub URLs
			if (url) {
				// Check if it's a GitHub URL and convert to raw
				if (url.includes('github.com') && url.includes('/blob/')) {
					url = url.replace(/\/\/github\.com/, '//raw.githubusercontent.com').replace(/\/blob\//, '/');
				}
			}

			var fetchProxy = function (url, options, i) {
				var proxy = [
					'', // try without proxy first
					'https://api.codetabs.com/v1/proxy/?quest='
				];

				// Add cache-busting parameter to the fetch URL
				var fetchUrl = proxy[i] + url;
				if (timestampParam) {
					// If we already have a timestamp from the main URL, use it
					fetchUrl += timestampParam;
				} else {
					// Otherwise add fresh timestamp to bypass cache
					var separator = url.includes('?') ? '&' : '?';
					fetchUrl += separator + '_t=' + Date.now();
				}

				return fetch(fetchUrl, options).then(function (res) {
					if (!res.ok) throw new Error('Cannot load ' + url + ': ' + res.status + ' ' + res.statusText);
					return res.text();
				}).catch(function (error) {
					if (i === proxy.length - 1)
						throw error;
					return fetchProxy(url, options, i + 1);
				})
			};

			// Check if we have a valid URL to load
			if (url && (url.startsWith('http://') || url.startsWith('https://')) && url.indexOf(window.location.hostname) < 0) {
				// Check if this is a .codecanvas file
				if (url.toLowerCase().endsWith('.codecanvas')) {
					// Show the preview container
					previewForm.style.display = 'none';
					previewContainer.style.display = 'block';

					// Load the .codecanvas file in an iframe
					fetchProxy(url, null, 0)
						.then(function (htmlContent) {
							// Create a blob URL for the content
							const blob = new Blob([htmlContent], { type: 'text/html' });
							const blobUrl = URL.createObjectURL(blob);

							// Load it in the iframe
							previewContainer.src = blobUrl;

							// Clean up blob URL after loading
							previewContainer.onload = function () {
								URL.revokeObjectURL(blobUrl);
							};
						})
						.catch(function (error) {
							console.error(error);
							previewForm.style.display = 'block';
							previewForm.innerHTML = '<p class="error-message">Error loading .codecanvas file: ' + error.message + '</p><p><a href="' + basePath + '">Try again</a></p>';
						});
				} else {
					// Not a .codecanvas file, show error
					previewForm.style.display = 'block';
					previewForm.innerHTML = '<p class="error-message">Only .codecanvas files are supported. Please provide a .codecanvas file URL.</p><p><a href="' + basePath + '">Try again</a></p>';
				}
			} else {
				// Show the form
				previewForm.style.display = 'block';
				// If there's a URL in the input, pre-fill it
				if (url) {
					document.getElementById('file').value = url;
				}
			}

		})();
	</script>
</body>

</html>
